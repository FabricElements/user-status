<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymerfire/firebase-auth.html">
<link rel="import" href="../polymerfire/polymerfire.html">

<dom-module id="user-status">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <firebase-auth signed-in="{{signedIn}}"
        user="{{user}}">
    </firebase-auth>
  </template>

  <script>
    /**
     * `user-status`
     *
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class UserStatus extends Polymer.Element {
      static get is() {
        return 'user-status';
      }
      static get properties() {
        return {
          status: {
            type: Boolean,
            value: false,
            notify: true,
            reflectToAttribute: true,
          },
          signedIn: {
            type: Boolean,
            value: false,
          },
          user: {
            type: Object,
            value: {},
            observer: '_userObserver',
          },
        };
      }
      /**
       * User observer
       *
       * @param {object} user
       * @private
       */
      _userObserver(user) {
        if (!user) return;
        // https://firebase.google.com/docs/firestore/solutions/presence
        // Create a reference to this user's specific status node.
        // This is where we will store data about being online/offline.
        const userStatusDatabaseRef = firebase.database().ref(`/user-status/${user.uid}`);
        // We'll create two constants which we will write to
        // the Realtime database when this device is offline
        // or online.
        const isOfflineForDatabase = {
          state: "offline",
          last_changed: firebase.database.ServerValue.TIMESTAMP,
        };
        const isOnlineForDatabase = {
          state: "online",
          last_changed: firebase.database.ServerValue.TIMESTAMP,
        };
        userStatusDatabaseRef.on("value", (snapshot) => {
          if (snapshot.val().state !== 'online') {
            userStatusDatabaseRef.set(isOnlineForDatabase).then(() => {
              this.status = true;
            });
          };
        });
        userStatusDatabaseRef.onDisconnect().set(isOfflineForDatabase).then(() => {
          this.status = false;
        });

      }
    }
    window.customElements.define(UserStatus.is, UserStatus);

  </script>
</dom-module>
